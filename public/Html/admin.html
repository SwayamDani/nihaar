<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Buddy - Admin Dashboard</title>
    <style>
        :root {
            --primary: #3c3d37;
            --secondary: #697565;
            --accent: #f39c12;
            --bg: #ecdfcc;
            --text: #181c14;
            --light: #ffffff;
            --border: #ddd;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: var(--text);
            line-height: 1.6;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        nav {
            background-color: var(--light);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        nav ul {
            list-style: none;
            display: flex;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        nav ul li a:hover, 
        nav ul li a.active {
            background-color: var(--primary);
            color: var(--light);
        }
        
        .card {
            background-color: var(--light);
            border-radius: 5px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--secondary);
            color: var(--light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 1.4rem;
            margin: 0;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--light);
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--secondary);
        }
        
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .stat-card .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, 
        table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        table th {
            background-color: #f1f1f1;
            font-weight: bold;
            color: var(--primary);
        }
        
        table tr:hover {
            background-color: rgba(105, 117, 101, 0.05);
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .status-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .status-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--light);
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background-color: var(--primary);
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-style: italic;
            color: #666;
        }
        
        .error-message {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-form {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .search-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: #666;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
            }
            
            nav ul li {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header>
            <h1>Travel Buddy Admin Dashboard</h1>
            <div>
                <a href="home.html" class="btn">Back to Website</a>
            </div>
        </header>
        
        <nav>
            <ul>
                <li><a href="#" class="tab-link active" data-tab="dashboard">Dashboard</a></li>
                <li><a href="#" class="tab-link" data-tab="bookings">Bookings</a></li>
                <li><a href="#" class="tab-link" data-tab="reviews">Reviews</a></li>
                <li><a href="#" class="tab-link" data-tab="destinations">Destinations</a></li>
            </ul>
        </nav>
        
        <!-- Dashboard Overview Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Total Bookings</h3>
                    <div class="stat-value" id="total-bookings">--</div>
                    <div class="stat-label">All time</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Reviews</h3>
                    <div class="stat-value" id="total-reviews">--</div>
                    <div class="stat-label">Across all destinations</div>
                </div>
                
                <div class="stat-card">
                    <h3>Destinations</h3>
                    <div class="stat-value" id="total-destinations">--</div>
                    <div class="stat-label">Available for booking</div>
                </div>
                
                <div class="stat-card">
                    <h3>Average Rating</h3>
                    <div class="stat-value" id="average-rating">--</div>
                    <div class="stat-label">Based on all reviews</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>Recent Bookings</h2>
                    <a href="#" class="btn btn-sm tab-link" data-tab="bookings">View All</a>
                </div>
                <div class="card-body">
                    <table id="recent-bookings-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Destination</th>
                                <th>Travel Date</th>
                                <th>Guests</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Loading recent bookings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>Recent Reviews</h2>
                    <a href="#" class="btn btn-sm tab-link" data-tab="reviews">View All</a>
                </div>
                <div class="card-body">
                    <table id="recent-reviews-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Destination</th>
                                <th>Rating</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Loading recent reviews...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Bookings Tab -->
        <div id="bookings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>All Bookings</h2>
                </div>
                <div class="card-body">
                    <div class="search-form">
                        <input type="email" id="booking-search" placeholder="Search by email...">
                        <button class="btn" id="booking-search-btn">Search</button>
                    </div>
                    
                    <table id="all-bookings-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Destination</th>
                                <th>Travel Date</th>
                                <th>Guests</th>
                                <th>Total</th>
                                <th>Booking Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="loading">Loading bookings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reviews Tab -->
        <div id="reviews" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>All Reviews</h2>
                </div>
                <div class="card-body">
                    <table id="all-reviews-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Destination</th>
                                <th>Rating</th>
                                <th>Comment</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Loading reviews...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Destinations Tab -->
        <div id="destinations" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>All Destinations</h2>
                </div>
                <div class="card-body">
                    <table id="all-destinations-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Packages</th>
                                <th>Avg. Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Loading destinations...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2025 Travel Buddy Admin Panel</p>
        </div>
    </div>
    
    <script>
    // Global data storage
    const data = {
        destinations: [],
        bookings: [],
        reviews: [],
        packages: []
    };
    
    // Tab navigation
    document.querySelectorAll('.tab-link').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get the tab to show
            const tabId = this.getAttribute('data-tab');
            
            // Update active tab link
            document.querySelectorAll('.tab-link').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');
            
            // Show the tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // Format date
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }
    
    // Format currency
    function formatCurrency(value) {
        return '$' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }
    
    // Generate star rating HTML
    function generateStars(rating) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHtml += '★'; // Full star
            } else {
                starsHtml += '☆'; // Empty star
            }
        }
        return starsHtml;
    }
    
    // Load destinations
    async function loadDestinations() {
        try {
            const response = await fetch('/api/destinations');
            if (!response.ok) {
                throw new Error('Failed to load destinations');
            }
            
            const destinations = await response.json();
            data.destinations = destinations;
            
            // Update dashboard stats
            document.getElementById('total-destinations').textContent = destinations.length;
            
            // Update destinations table
            const tableBody = document.getElementById('all-destinations-table').querySelector('tbody');
            
            if (destinations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No destinations found</td></tr>';
                return;
            }
            
            // Load destinations table
            tableBody.innerHTML = '';
            
            destinations.forEach(destination => {
                // Calculate average rating for destination
                let avgRating = 'No reviews';
                let packagesCount = 0;
                
                // Find reviews for this destination
                const destinationReviews = data.reviews.filter(review => review.destination_id === destination.id);
                if (destinationReviews.length > 0) {
                    const totalRating = destinationReviews.reduce((sum, review) => sum + review.rating, 0);
                    avgRating = (totalRating / destinationReviews.length).toFixed(1) + ' ★';
                }
                
                // Find packages for this destination
                const destinationPackages = data.packages.filter(pkg => pkg.destination_id === destination.id);
                packagesCount = destinationPackages.length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${destination.id}</td>
                    <td>${destination.name}</td>
                    <td>${destination.country || 'N/A'}</td>
                    <td>${packagesCount}</td>
                    <td>${avgRating}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading destinations:', error);
            const tableBody = document.getElementById('all-destinations-table').querySelector('tbody');
            tableBody.innerHTML = `<tr><td colspan="5">Error loading destinations: ${error.message}</td></tr>`;
        }
    }
    
    // Load reviews
    async function loadReviews() {
        try {
            // Here we would need a proper API endpoint to get all reviews
            // Since we don't have one, we'll simulate with destination-specific requests
            
            let allReviews = [];
            
            for (const destination of data.destinations) {
                const response = await fetch(`/api/reviews/destination/${destination.id}`);
                if (response.ok) {
                    const reviews = await response.json();
                    // Add destination name to each review
                    reviews.forEach(review => {
                        review.destination_name = destination.name;
                    });
                    allReviews = [...allReviews, ...reviews];
                }
            }
            
            data.reviews = allReviews;
            
            // Update dashboard stats
            document.getElementById('total-reviews').textContent = allReviews.length;
            
            // Calculate average rating
            if (allReviews.length > 0) {
                const totalRating = allReviews.reduce((sum, review) => sum + review.rating, 0);
                const avgRating = (totalRating / allReviews.length).toFixed(1);
                document.getElementById('average-rating').textContent = avgRating;
            } else {
                document.getElementById('average-rating').textContent = 'N/A';
            }
            
            // Update recent reviews table
            const recentTableBody = document.getElementById('recent-reviews-table').querySelector('tbody');
            
            if (allReviews.length === 0) {
                recentTableBody.innerHTML = '<tr><td colspan="5">No reviews found</td></tr>';
            } else {
                // Show only 5 most recent reviews
                const recentReviews = [...allReviews].sort((a, b) => new Date(b.review_date) - new Date(a.review_date)).slice(0, 5);
                
                recentTableBody.innerHTML = '';
                
                recentReviews.forEach(review => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${review.id}</td>
                        <td>${review.name}</td>
                        <td>${review.destination_name}</td>
                        <td>${generateStars(review.rating)}</td>
                        <td>${formatDate(review.review_date)}</td>
                    `;
                    
                    recentTableBody.appendChild(row);
                });
            }
            
            // Update all reviews table
            const allTableBody = document.getElementById('all-reviews-table').querySelector('tbody');
            
            if (allReviews.length === 0) {
                allTableBody.innerHTML = '<tr><td colspan="6">No reviews found</td></tr>';
            } else {
                // Sort reviews by date (newest first)
                const sortedReviews = [...allReviews].sort((a, b) => new Date(b.review_date) - new Date(a.review_date));
                
                allTableBody.innerHTML = '';
                
                sortedReviews.forEach(review => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${review.id}</td>
                        <td>${review.name}</td>
                        <td>${review.destination_name}</td>
                        <td>${generateStars(review.rating)}</td>
                        <td>${review.comment}</td>
                        <td>${formatDate(review.review_date)}</td>
                    `;
                    
                    allTableBody.appendChild(row);
                });
            }
            
        } catch (error) {
            console.error('Error loading reviews:', error);
            document.getElementById('recent-reviews-table').querySelector('tbody').innerHTML = 
                `<tr><td colspan="5">Error loading reviews: ${error.message}</td></tr>`;
            document.getElementById('all-reviews-table').querySelector('tbody').innerHTML = 
                `<tr><td colspan="6">Error loading reviews: ${error.message}</td></tr>`;
        }
    }
    
    // Load bookings
    async function loadBookings() {
        try {
            // This is a placeholder since we don't have a proper API endpoint to get all bookings
            // In a real application, you would add an endpoint to get all bookings
            
            let allBookings = [];
            
            // Simulated bookings for demonstration - we would normally fetch this from the API
            allBookings = [
                {
                    id: 1,
                    name: 'John Smith',
                    email: 'john@example.com',
                    package_id: 1,
                    destination_name: 'Bali',
                    travel_date: '2025-06-15',
                    guests: 2,
                    total_price: 3999.98,
                    booking_date: '2025-03-20T14:30:00Z'
                },
                {
                    id: 2,
                    name: 'Sarah Johnson',
                    email: 'sarah@example.com',
                    package_id: 3,
                    destination_name: 'New York',
                    travel_date: '2025-07-10',
                    guests: 1,
                    total_price: 1899.99,
                    booking_date: '2025-04-02T10:15:00Z'
                },
                {
                    id: 3,
                    name: 'Michael Brown',
                    email: 'michael@example.com',
                    package_id: 6,
                    destination_name: 'Bora Bora',
                    travel_date: '2025-08-22',
                    guests: 2,
                    total_price: 9999.98,
                    booking_date: '2025-04-05T09:45:00Z'
                }
            ];
            
            data.bookings = allBookings;
            
            // Update dashboard stats
            document.getElementById('total-bookings').textContent = allBookings.length;
            
            // Update recent bookings table
            const recentTableBody = document.getElementById('recent-bookings-table').querySelector('tbody');
            
            if (allBookings.length === 0) {
                recentTableBody.innerHTML = '<tr><td colspan="6">No bookings found</td></tr>';
            } else {
                // Show only 5 most recent bookings
                const recentBookings = [...allBookings].sort((a, b) => new Date(b.booking_date) - new Date(a.booking_date)).slice(0, 5);
                
                recentTableBody.innerHTML = '';
                
                recentBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.name}</td>
                        <td>${booking.destination_name}</td>
                        <td>${formatDate(booking.travel_date)}</td>
                        <td>${booking.guests}</td>
                        <td>${formatCurrency(booking.total_price)}</td>
                    `;
                    
                    recentTableBody.appendChild(row);
                });
            }
            
            // Update all bookings table
            const allTableBody = document.getElementById('all-bookings-table').querySelector('tbody');
            
            if (allBookings.length === 0) {
                allTableBody.innerHTML = '<tr><td colspan="8">No bookings found</td></tr>';
            } else {
                // Sort bookings by date (newest first)
                const sortedBookings = [...allBookings].sort((a, b) => new Date(b.booking_date) - new Date(a.booking_date));
                
                allTableBody.innerHTML = '';
                
                sortedBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.name}</td>
                        <td>${booking.email}</td>
                        <td>${booking.destination_name}</td>
                        <td>${formatDate(booking.travel_date)}</td>
                        <td>${booking.guests}</td>
                        <td>${formatCurrency(booking.total_price)}</td>
                        <td>${formatDate(booking.booking_date)}</td>
                    `;
                    
                    allTableBody.appendChild(row);
                });
            }
            
        } catch (error) {
            console.error('Error loading bookings:', error);
            document.getElementById('recent-bookings-table').querySelector('tbody').innerHTML = 
                `<tr><td colspan="6">Error loading bookings: ${error.message}</td></tr>`;
            document.getElementById('all-bookings-table').querySelector('tbody').innerHTML = 
                `<tr><td colspan="8">Error loading bookings: ${error.message}</td></tr>`;
        }
    }
    
    // Initialize the dashboard
    async function initDashboard() {
        try {
            // First load destinations
            await loadDestinations();
            
            // Then load reviews (which need destination data)
            await loadReviews();
            
            // Finally load bookings
            await loadBookings();
            
        } catch (error) {
            console.error('Error initializing dashboard:', error);
        }
    }
    
    // Booking search functionality
    document.getElementById('booking-search-btn').addEventListener('click', function() {
        const searchEmail = document.getElementById('booking-search').value.toLowerCase().trim();
        const tableBody = document.getElementById('all-bookings-table').querySelector('tbody');
        
        if (!searchEmail) {
            // Reset to show all bookings
            loadBookings();
            return;
        }
        
        // Filter bookings by email
        const filteredBookings = data.bookings.filter(booking => 
            booking.email.toLowerCase().includes(searchEmail)
        );
        
        if (filteredBookings.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8">No bookings found for email: ${searchEmail}</td></tr>`;
            return;
        }
        
        tableBody.innerHTML = '';
        
        filteredBookings.forEach(booking => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${booking.id}</td>
                <td>${booking.name}</td>
                <td>${booking.email}</td>
                <td>${booking.destination_name}</td>
                <td>${formatDate(booking.travel_date)}</td>
                <td>${booking.guests}</td>
                <td>${formatCurrency(booking.total_price)}</td>
                <td>${formatDate(booking.booking_date)}</td>
            `;
            
            tableBody.appendChild(row);
        });
    });
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>